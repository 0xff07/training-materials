\subchapter{First compilation}{Get used to the build mechanism}

During this lab, you will:
\begin{itemize}
  \item Configure which system to build Android for
  \item Compile your first Android root filesystem
\end{itemize}

\section{Setup}

Stay in the \code{$HOME/felabs/android/source} directory.

\section{Build environment}

Now that \code{repo sync} is over, we will compile an Android system
for the emulator. This will include building the emulator itself.

First, run \code{source build/envsetup.sh}.

This file contains many useful shell functions and aliases, such as
\code{croot} to go to the root directory of the Android source code or
\code{lunch}, to select the build options.

Check your \code{PATH} environment variable:

\begin{verbatim}
echo $PATH
\end{verbatim}

You will see that \code{build/envsetup.sh} hasn't modified your
\code{PATH}.  This will be done during the build job.

The target product for the emulator is {\it generic}, and we want to
have an engineering build. To do this, run \code{lunch generic-eng}

\section{Patches for Ubuntu 12.04 and beyond}

Google supports Ubuntu 10.04 for building Android 2.3 Gingerbread.
However, with two minor patches, it is possible to build this version
with Ubuntu 12.04.

Let's apply these patches (stay in the \code{android} directory to run
the below command):

\begin{verbatim}
cat $HOME/felabs/android/aosp/patches/*.patch | patch -p1
\end{verbatim}

\section{Fixes for Ubuntu 12.10}

We don't officially support Ubuntu 12.10 for our Android labs, but you
may be forced to use this version if you have a recent PC and earlier
versions of Ubuntu don't support it yet.

Ubuntu 12.10 ships with gcc 4.7, which is too recent to build Android
2.3. Hence, we need to install gcc 4.6, and make it the default version
used on your system:

\begin{verbatim}
sudo apt-get install gcc-4.6 g++-4.6 gcc-4.6-multilib g++-4.6-multilib
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.7 50
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-4.6 100
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.7 50
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-4.6 100
sudo update-alternatives --install /usr/bin/cpp cpp-bin /usr/bin/cpp-4.7 50
sudo update-alternatives --install /usr/bin/cpp cpp-bin /usr/bin/cpp-4.6 100
sudo update-alternatives --set g++ /usr/bin/g++-4.6
sudo update-alternatives --set g++ /usr/bin/gcc-4.6
sudo update-alternatives --set cpp-bin /usr/bin/cpp-4.6
\end{verbatim}

\section{Compile the root filesystem}

The build system will use the proper setup to build this
target. Before running \code{make}, first check the number of CPU
cores in your workstation, as seen by the operating system
(hyperthreading could make your OS see 4 cores instead of 2, for
example).

\begin{verbatim}
cat /proc/cpuinfo
\end{verbatim}

You can use \code{make -j} (\code{j} stands for {\it jobs} to instruct
\code{make} to run multiple compile jobs in parallel, taking advantage
of the multiple CPU cores, and making sure that I/Os and CPU cores are
always at 100\%. This will significantly reduce build time.

For example, if Linux sees 4 cores, you will get good performance by
specifying the double number of parallel jobs:

\begin{verbatim}
make -j 8
\end{verbatim}

Go grab (several cups of) coffee!

\paragraph{Known issue}
In rare circumstances, some builds can fail when \code{make} is run
with multiple jobs in parallel. If this happens, you can run
\code{make} with no option after the failure, and this is likely to
make the issue disappear.

\section{Test your Android build}

Now, look at the \code{PATH} environment variable again.

You can see that it contains:
\begin{itemize}
\item
  \code{$HOME/felabs/android/source/out/host/linux-x86/bin/}.
  That's where new utilities have just been compiled.
\item Prebuilt executables, in particular the ARM cross-compiling
  toolchain, which was already present in the repositories fetched by
  \code{repo}.
\end{itemize}

Look at the contents of the \code{out/target/product/generic} folder.
That's where the system images have been built.

Run the \code{emulator} command. It will run the emulator with these
generated images.  Wait a few minutes for the emulator to load the
system, and then check the build number in the \code{Settings}
application in Android.

\paragraph{Note}
The \code{PATH} settings automatically added by the build process will
be lost if you close your terminal. We will see how to restore this
environment in the next lab.
