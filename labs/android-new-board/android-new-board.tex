\subchapter{Supporting a new board}{Learn how to make Android on new
hardware}

After this lab, you will be able to:
\begin{itemize}
  \item Boot Android on a real hardware
  \item Troubleshoot simple problems on Android
  \item Generate a working build
\end{itemize}

\section{Download the source code}

Go to the \code{$HOME/felabs/android/source} directory.

We will use the TI-flavored Android build, named rowboat, for our
board. This should make most of the port ready to use, and only a few
fixes here and there will be needed.

\code{repo} allows to download a new Android tree in a smart way,
downloading only the differences between the new manifest we would
give him and the current code we have. To do so, we first need to
change the manifest we use to the rowboat's one.

\begin{verbatim}
repo init -u git://gitorious.org/rowboat/manifest.git \
    -b master -m rowboat-jb-am335x.xml
\end{verbatim}

Now, let's run the big download job:
\begin{verbatim}
repo sync -c -j4
\end{verbatim}

\section{Build Android for the BeagleBone Black}

As we said earlier, rowboat already includes support for the
BeagleBone Black we're using. To compile it, we have to use lunch, in
the same way we did previously:

\begin{verbatim}
source build/envsetup.sh
lunch beagleboneblack-eng
\end{verbatim}

And finally, we can start the compilation:

\begin{verbatim}
make OMAPES=4.x -jX
\end{verbatim}

Once again, you can expect this build job to take quite a long time (a
few hours) to run, even on a recent and rather fast laptop.

This job will build four images in
\code{out/target/product/beagleboneblack}: \code{cache.img},
\code{ramdisk.img}, \code{system.img} and \code{userdata.img}.

These images are the one usually generated by the Android build
system. However, rowboat provides all the tools needed to flash an
image to an SD card, but they do use a tarball containing the whole
Android system.

To create such a tarball, you can use the following make target:

\begin{verbatim}
make OMAPES=4.x fs_tarball
\end{verbatim}

It will generate in \code{out/target/product/beagleboneblack} a
rootfs.tar.bz2 tarball holding all the files needed for Android to
boot.

We then need to put this image on an SD card so that we can boot on
the system we just generated.

First, take the SD card provided by your instructor, and insert it
into an SD card reader slot in your workstation, or into a USB card
reader provided by your instructor too. Then, using the \code{dmesg}
command, find which device your workstation uses for your SD card.
Let's assume that this device is \code{/dev/sdc}.

Rowboat comes with a script that will format the SD card with the
geometry expected by the SoC to be able to boot it, with the correct
partitions, and copy everything we compiled so that we end up with a
ready-to-use SD card.

You can use this script with the following commands:

\begin{verbatim}
sudo external/ti_android_utilities/am335x/mk-mmc/mkmmc-android.sh \
    /dev/sdc u-boot/MLO u-boot/u-boot.img kernel/arch/arm/boot/uImage \
    external/ti_android_utilities/am335x/u-boot-env/uEnv_beagleboneblack.txt \
    out/target/product/beagleboneblack/rootfs.tar.bz2
\end{verbatim}

Once this command is over, you can remove the SD card and insert it
into the corresponding slot on the BeagleBone board.

\section{Setting up serial communication with the board}

To see the board boot, we need to read the first boot messages issued
on the board's serial port.

Your instructor will provide you with a special serial cable for the
Beaglebone, that is basically a USB-to-serial adapter for the
connection with your laptop.

When you plug in this adaptor, a serial port should appear on your
workstation: \code{/dev/ttyUSB0}.

You can also see this device appear by looking at the output of the
\code{dmesg} command.

To communicate with the board through the serial port, install a
serial communication program, such as \code{picocom}:
\footnote{\code{picocom} is one of the simplest utilities to access a
  serial console. \code{minicom} looks more featureful, but is also
  more complex to configure.}

\begin{verbatim}
sudo apt-get install picocom
\end{verbatim}

You also need to make your user belong to the \code{dialout} group to be
allowed to write to the serial console:

\begin{verbatim}
sudo adduser $USER dialout
\end{verbatim}

You need to log out and in again for the group change to be effective.

Run \code{picocom -b 115200 /dev/ttyUSB0}, to start serial
communication on \code{/dev/ttyUSB0}, with a baudrate of 115200. If
you wish to exit \code{picocom}, press \code{[Ctrl][a]} followed by
\code{[Ctrl][x]}.

\section{Booting the board}

Once you inserted the SD card, you can boot the board by holding the
\code{boot} key while switching the board on. On the serial port, you
should see Android going through its boot process, until you finally
have a shell on the serial link and the screen working properly.

\section{TODO: Fix the screen resolution}